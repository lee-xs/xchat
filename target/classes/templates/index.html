<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>XChat在线聊天室</title>

    <link rel="shortcut icon" href="https://q1.qlogo.cn/g?b=qq&nk=52110919&s=640">
    <!-- bootstrap css -->
    <link rel="stylesheet" href="/bootstrap/css/bootstrap.css">
    <!-- Layui css -->
    <link rel="stylesheet" href="/layui/css/layui.css" />
    <!-- Soho css -->
    <link rel="stylesheet" href="/css/soho.min.css">
    <style type="text/css">
        .img {
            width: 100px;
            height: 100px;
            padding: 5px;
        }
        .img:hover{
            border: 1px solid #ff8711;
        }
    </style>
</head>
<body>
<!-- layout -->
<div class="layout">

    <!-- content -->
    <div class="content" style="padding: 20px;">
        <!-- chat -->
        <div class="chat">
            <div class="chat-header" style="padding-bottom: 10px;">
                <div class="chat-header-user">
                    <figure class="avatar avatar-lg">
                        <img id="infoAvatar" src="img/6.jpg" class="rounded-circle">
                    </figure>
                    <div>
                        <h5 id="infoName"></h5>
                        <small class="text-muted">
                            <i>Online</i>
                        </small>
                    </div>
                </div>
                <div class="chat-header-action" style="text-align: right;">
                    <p id="online"></p>
                    <p id="date"></p>
                </div>
            </div>
            <div id="main" class="chat-body">
                <div id="message" class="messages">
                    <!-- 内容展示区域 -->
                </div>
            </div>
            <div class="chat-footer">
                <form onsubmit="return false">
                    <input id="inputMessage" type="text" class="form-control" autocomplete="off" placeholder="请输入内容">
                    <div class="form-buttons">
                        <div onclick="send()" class="btn btn-primary btn-floating">
                            <i class="fa fa-send"></i>
                        </div>
                    </div>
                </form>
            </div>
        </div>
        <!-- ./ chat -->
    </div>
    <!-- ./ content -->
</div>
<!-- ./ layout -->



<div class="modal fade" id="inputInfoModal" data-backdrop="static" data-keyboard="false">
    <div  class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content" style="background-color: #393D49;">
            <div class="modal-body">
                <div>
                    <input type="text" id="name" name="name" placeholder="请输入用户名，并选择一个头像后进入聊天室"  style="padding-left: 10px; width: 100%; border-radius: 2px; border-style: solid; line-height: 1.3; height: 38px; border-width: 1px; border-color: #e6e6e6;outline:none;" autocomplete="off"/>
                    <div id="infoResult" style="width: 100%; margin-top: 5px; color: red; font-size: 12px;"></div>
                </div>
                <div class="container">
                    <div class="row" id="imgList">

                    </div>
                </div>
            </div>
            <div class="modal-footer" style="border: none; padding: 10px 0; background: #fff;">
                <div id="putInfo" type="button" style="margin: auto;" class="btn btn-primary">确认</div>
            </div>
        </div>
    </div>
</div>
</body>





<!-- JQuery -->
<script src="/js/jquery-3.4.1.js"></script>
<!-- Bootstrap -->
<script src="/vendor/bootstrap/bootstrap.min.js"></script>
<!-- Nicescroll -->
<script src="/vendor/jquery.nicescroll.min.js"></script>
<!-- Soho -->
<script src="/js/soho.min.js"></script>
<!-- sohu ip -->
<script src="http://pv.sohu.com/cityjson?ie=utf-8"></script>

<!-- layui js -->
<script src="/layui/layui.js"></script>

<script type="text/javascript">
    let websocket = null;
    let user = {};
    let img;

    //时间走动
    getDates()

    $(document).ready(function () {
        console.log("访问IP地址 =====> " + returnCitySN["cip"])

        /**
         * 获取用户信息
         */
        $.ajax({
            type: 'get',
            url: '/info/' + returnCitySN["cip"],
            async: false,
            success: function(res) {
                user = res.data
                if(user.name != "" && user.name != null && user.avatar != "" && user.avatar != null){
                    $('#infoName').text("用户名：" + user.name)
                    $('#infoAvatar').attr('src', user.avatar)
                }
                handleTimerOnline()
                setInterval("handleTimerOnline()", 2000)
            }
        })

        if(user.name == "" || user.name == null || user.name == undefined){

            for(let i = 1; i < 22; i++){
                $('#imgList').append(`<div class="col-2" style="padding: 2px;"><img style="width: 100%;" src="/img/${i}.jpg" class="carousel-inner img-responsive img-rounded"/></div>`)
            }

            $('#inputInfoModal').modal('show')



            layui.use(['layer'], function () {
                const layer = layui.layer

                /**
                 * 打开输入用户名输入框
                //  */
                // layer.open({
                //     type: 1
                //     ,title: false //不显示标题栏
                //     ,closeBtn: false
                //     ,area: ['800px', '470px']
                //     ,shade: 0.9 //遮罩透明度
                //     ,id: 'name_enter' //设定一个id，防止重复弹出
                //     ,content: `
                //         <div>
                //             <div id="inputInfo" style="padding: 30px 50px; line-height: 22px; background-color: #393D49; color: #fff; font-weight: 300;">
                //                 <input type="text" id="name" name="title" placeholder="请输入用户名,并选择一个头像后进入聊天室" autocomplete="off" class="layui-input">
                //                 <div id="infoResult" style="width: 100%; height: 30px; color: red; font-size: 12px;"></div>
                //                 <div id="imgList" style=" "></div>
                //             </div>
                //             <div id="putInfo" class="layui-btn" style="width: 100%; height: 42px; line-height: 42px; text-align: center; background: #1E9FFF; color: #FFFFFF;">确定</div>
                //         </div>
                //      `
                //     ,success: function (index, layero) {
                //         for(let i = 1; i < 22; i++){
                //             $('#imgList').append(`<img src="/img/${i}.jpg" class="img"/>`)
                //             //$('#imgList').append(`<div class="col-2" style="padding: 2px;"><img style="width: 100%;" src="/img/${i}.jpg" class="img"/></div>`)
                //         }
                //     }
                // });
            })

            /**
             * 设置选中头像的样式
             */
            $('.col-2').click(function () {
                const that = $(this)
                img = that.children()[0].src
                that.children().css("border", "1px solid #1E9FFF")
                that.siblings().children().css("border", "none")
            })

            /**
             * 添加信息
             */
            $('#putInfo').click(function () {
                const val = $('#name').val()
                if(val != '' && val != null && img != '' && img != null){
                    $.post('/put', {"ip": returnCitySN["cip"], "name": $('#name').val(), "avatar": img }, function (res) {
                        if(res.code == 200){
                            //info()
                            //$('#inputInfoModal').modal('hide');
                            window.location.reload()
                        } else if (res.code == 409){
                            $('#infoResult').text(res.message)
                        }
                    })
                }else{
                    $('#infoResult').text("请填写用户名并选择头像后进入")
                }
            })
        }



        if('WebSocket' in window) {
            //websocket = new WebSocket("ws://blog.aleestar.cn:2923/websocket/" + returnCitySN["cip"])
            websocket = new WebSocket("ws://localhost:2923/websocket/" + returnCitySN["cip"])
        } else {
            alert("Not Support WebSocket")
        }

        websocket.onerror = function(event){
            wirteMessageInnerHTML("【系统消息】=> error");
        }

        websocket.onopen = function(){
            wirteMessageInnerHTML("【系统消息】=> 成功连接服务器...");
        }

        websocket.onmessage = function(event){
            parseMassage(event.data);
        }

        websocket.onclose = function(){
            wirteMessageInnerHTML("【系统消息】=> 关闭连接");
        }

        /**
         * 监听窗口关闭事件，当窗口关闭时，主动去关闭websocket连接，防止连接还没断开就关闭窗口，server端会抛异常。
         */
        window.onbeforeunload = function(){
            websocket.close();
        }
    })


    /**
     * 将消息对象进行处理后展示
     */
    function parseMassage(data){
        data = JSON.parse(data)
        if(data instanceof Array){
            data.forEach((item) => {
                message(item)
            })
        }else{
            message(data)
        }
    }
    function message(data) {
        let message;
        if(data.user.name == user.name){
            message = `
                <div class="message-item outgoing-message" style="margin-top: 12px;">
                    <div style="float: left;">
                        <div style="text-align: left; float:right; font-size: 12px; margin: 0 0 5px 0; color: #828282;">【${data.user.name}】  ${data.now}</div>
                        <div><span style='font-size: 14px; float: right; padding: 8px 20px; border-radius: 5px; background-color: #CDCDCD; color: #212529;'>${data.content}</span></div>
                    </div>
                    <div style="float: right;"><img src="${data.user.avatar}" style="width: 40px; height: 40px; margin-left: 10px; border-radius: 50%"/></div>
                </div>`
        } else {
            message = `
                <div class="message-item">
                    <div style="float: right;" style="margin-top: 12px;">
                        <div style="text-align: left; float:left; font-size: 12px; margin: 0 0 5px 0; color: #828282;">【${data.user.name}】  ${data.now}</div>
                        <div><span style='font-size: 14px; float: left; padding: 8px 20px; border-radius: 5px; background-color: #CDCDCD; color: #212529;'>${data.content}</span></div>
                    </div>
                    <div style="float: left;"><img src="${data.user.avatar}" style="width: 40px; height: 40px; margin-right: 10px; border-radius: 50%"/></div>
                </div>`
        }
        wirteMessageInnerHTML(message)
    }

    /**
     * 展示消息 输出信息到页面展示
     * @param data
     */
    function wirteMessageInnerHTML(data) {
        document.getElementById("message").innerHTML += data
        const that = document.getElementById("main")
        that.scrollTop = that.scrollHeight
    }

    /**
     * 关闭WebSocket
     */
    function closeWebSocket(){
        websocket.close();
    }

    /**
     * 回车触发发送
     */
    $('#inputMessage').keyup(function (event) {
        if(event.keyCode == 13){
            send()
        }
    })

    /**
     * 向服务器发送消息
     */
    function send() {
        let that = document.getElementById("inputMessage")
        let message = that.value
        if(websocket != null && (message != null && message != "" && message != undefined && message != "\n")){
            websocket.send(message)
            that.value = ''
        }
    }

    /**
     * 清空文本域内容
     */
    function remove() {
        $('#inputMessage').val('')
    }

    /**
     * 获取信息
     */
    function info() {
        $.get('/info/' + returnCitySN["cip"], function (res) {
            user = res.data
            $('#infoName').text("当前用户：" + user.name)
        })
    }

    /**
     * 定时去获取当前服务器在线人数
     */
    function handleTimerOnline() {
        $.get('/online', function (res) {
            $('#online').text("当前系统在线人数：" + res.data.online)
        })
    }

    /**
     * 时间走动
     */
    function getDates() {
        let w_array = new Array("星期天", "星期一", "星期二", "星期三", "星期四", "星期五", "星期六");
        let d = new Date();
        let year = d.getFullYear();
        let month = d.getMonth() + 1;
        let day = d.getDate();
        let week = d.getDay();
        let h = d.getHours();
        let mins = d.getMinutes();
        let s = d.getSeconds();

        if (month < 10) month = "0" + month;
        if (day < 10) day = "0" + day;
        if (h < 10) h = "0" + h;
        if (mins < 10) mins = "0" + mins;
        if (s < 10) s = "0" + s;

        let shows = "当前时间： <span>" + year + "-" + month + "-" + day + " " + h + ":" + mins + ":" + s + " " + w_array[week] + "</span>";
        document.getElementById("date").innerHTML = shows;
        setTimeout("getDates()",1000);
    }
</script>

</html>
