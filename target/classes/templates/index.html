<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>X-Chat</title>
    <link rel="stylesheet" href="layui/css/layui.css"/>
</head>
<body style="">
    <!--头部 -->
    <div id="header" style="width: 100%; height: 50px; line-height: 50px; font-size: 20px; text-align: center; background-color: #fff; box-shadow: 0 1px 3px rgba(26,26,26,.2);">
        <p>欢迎使用XChat在线聊天室</p>
    </div>

    <!-- 内容展示区 --><!--  background-image: url('http://qiniu.aleestar.cn/sketchBg03.jpg'); background-size: cover; -->
    <div id="main" style="width: 100%; height: 500px; overflow: auto;">
        <div id="message" style="width: 100%; ">

        </div>
    </div>

    <!-- 文本输入 -->
    <div style="width: 100%; overflow: hidden;"><!--  position: absolute; bottom: 0; -->
        <div style="padding: 0 10px; height: 40px; line-height: 40px; background-color: #c9c9c9; border-top: 1px solid #A3A3A3;">
            <div style="float: left">
                <span id="infoName"></span>
                <span id="online"></span>
            </div>
            <div style="float: right">
                <div onclick="send()" style="width: 60px;" class="layui-btn layui-btn-sm layui-btn-normal">发送</div>
                <div onclick="remove()" style="width: 60px;" class="layui-btn layui-btn-sm layui-btn-danger">清空</div>
            </div>
        </div>
        <textarea id="inputMessage" style="width: 100%; height: 100px; resize: none;"></textarea>
    </div>

    <!-- 输入用户名 -->
    <div id="inputName" style="display: none; padding: 50px; line-height: 22px; background-color: #393D49; color: #fff; font-weight: 300;">
        <input type="text" id="name" name="title" placeholder="请输入用户名"  class="layui-input">
    </div>
</body>
<script src="http://pv.sohu.com/cityjson?ie=utf-8"></script>
<!--<script src="wangEditor-3.1.1/release/wangEditor.js"></script>-->
<script src="js/jquery-3.4.1.js"></script>
<script src="layui/layui.all.js"></script>
<script type="text/javascript">
    let websocket = null;
    let user = {};

    $(document).ready(function () {
        console.log("访问IP地址 =====> " + returnCitySN["cip"])

        /**
         * 获取用户信息
         */
        $.ajax({
            type: 'get',
            url: '/info/' + returnCitySN["cip"],
            async: false,
            success: function(res) {
                user = res.data
                $('#infoName').text("当前用户：" + user.name)
                handleTimerOnline()
                setInterval("handleTimerOnline()", 5000)
            }
        })


        if(user.name == '' || user.name == null || user.name == undefined){
            layui.use(['layer'], function () {
                const layer = layui.layer

                /**
                 * 打开输入用户名输入框
                 */
                layer.open({
                    type: 1
                    ,title: false //不显示标题栏
                    ,closeBtn: false
                    ,area: '300px;'
                    ,shade: 0.8 //遮罩透明度
                    ,id: 'name_enter' //设定一个id，防止重复弹出
                    ,btn: ['确认']
                    ,btnAlign: 'c'  // 按钮居中对齐
                    ,moveType: 1 //拖拽模式，0或者1
                    ,content: $('#inputName')
                    ,yes: function (index, layero) {
                        const val = $('#name').val()
                        if(val != '' && val != null && val != undefined){
                            $.post('/ip/' + returnCitySN["cip"] + '/name/' + $('#name').val(), function (res) {
                                if(res.code == 200){
                                    info()
                                    layer.close(index)
                                } else if (res.code == 409){
                                    layer.msg(res.message)
                                }
                            })
                        }else{
                            layer.msg("请填写一个用户名后进入")
                        }
                    }
                });
            })
        }



        if('WebSocket' in window) {
            websocket = new WebSocket("ws://localhost:2922/websocket/" + returnCitySN["cip"])
        } else {
            alert("Not Support WebSocket")
        }

        websocket.onerror = function(event){
            wirteMessageInnerHTML("【系统消息】=> error");
        }

        websocket.onopen = function(){
            wirteMessageInnerHTML("【系统消息】=> 成功连接服务器...");
        }

        websocket.onmessage = function(event){
            wirteMessageInnerHTML(event.data);
        }

        websocket.onclose = function(){
            wirteMessageInnerHTML("【系统消息】=> 关闭连接");
        }

        /**
         * 监听窗口关闭事件，当窗口关闭时，主动去关闭websocket连接，防止连接还没断开就关闭窗口，server端会抛异常。
         */
        window.onbeforeunload = function(){
            websocket.close();
        }
    })

    function conectWebSocket() {
        var nickname = document.getElementById("nickname").value;
        if(nickname == null || nickname == ''){
            alert("昵称不能为空！")
            return;
        }

        if('WebSocket' in window){
            websocket = new WebSocket("ws://localhost:2922/websocket/" + nickname)
        }else{
            alert("Not Support WebSocket")
        }

        websocket.onerror = function(event){
            wirteMessageInnerHTML("【系统消息】=> error");
        }

        websocket.onopen = function(){
            wirteMessageInnerHTML("【系统消息】=> 成功连接服务器...");
        }

        websocket.onmessage = function(event){
            wirteMessageInnerHTML(event.data);
        }

        // websocket.onclose = function(){
        //     wirteMessageInnerHTML("【系统消息】=> 关闭连接");
        // }

        //监听窗口关闭事件，当窗口关闭时，主动去关闭websocket连接，防止连接还没断开就关闭窗口，server端会抛异常。
        window.onbeforeunload = function(){
            websocket.close();
        }
    }

    /**
     * 展示消息 输出信息到页面展示
     * @param innerHTML
     */
    function wirteMessageInnerHTML(innerHTML){
        document.getElementById("message").innerHTML += innerHTML
        const main = document.getElementById("main")
        main.scrollTop = main.scrollHeight
    }

    /**
     * 关闭WebSocket
     */
    function closeWebSocket(){
        websocket.close();
    }

    /**
     * 向服务器发送消息
     */
    function send() {
        let that = document.getElementById("inputMessage")
        const message = that.value;
        if(websocket != null && (message != null || message != '' || message != undefined)){
            websocket.send(message)
            that.value = ''
        }
    }

    /**
     * 清空文本域内容
     */
    function remove() {
        $('#inputMessage').val('')
    }

    /**
     * 获取信息
     */
    function info() {
        $.get('/info/' + returnCitySN["cip"], function (res) {
            user = res.data
            $('#infoName').text("当前用户：" + user.name)
        })
    }

    /**
     * 定时去获取当前服务器在线人数
     */
    function handleTimerOnline() {
        $.get('/online', function (res) {
            $('#online').text("当前在线人数：" + res.data.online)
        })
    }
</script>
<script type="text/javascript">
    // var E = window.wangEditor;
    // var editor = new E("#editor");
    // editor.create();
</script>

<style type="text/css">
/*.w-e-text-container {*/
/*    height: 150px !important;*/
/*}*/
</style>
</html>